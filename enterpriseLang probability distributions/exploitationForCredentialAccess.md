# Exploitation for Credential Access

written by Love Wessman (feel free to change this text with any updated findings/improved sources)

## Context
Exploitation of a software vulnerability occurs when an adversary takes advantage of a programming error in a program, service, or within the operating system software or kernel itself to execute adversary-controlled code. Credentialing and authentication mechanisms may be targeted for exploitation by adversaries as a means to gain access to useful credentials or circumvent the process to gain access to systems. One example of this is MS14-068, which targets Kerberos and can be used to forge Kerberos tickets using domain user permissions. Exploitation for credential access may also result in Privilege Escalation depending on the process targeted or credentials obtained[^1].

In this attack, an attacker attempts to gain access to the credentials of legitimate users on a system. This is a rather general type of attack and thus there are many different ways of performing it. 
Some of examples of attacks are considered exploitation for credential access: 

* Exploitation of SQL Injection vulnerability
* Forcing a Windows machine to try to authenticate to a remote server, to get and crack password hashes from email
* exploitation of vulnerabilities that allow an attacker to bypass need for credentials entirely: MS14-068

## SQL Injection vulnerability 

### success rate of attack
[Acunetix 2019 vulnerability report](https://cdn2.hubspot.net/hubfs/4595665/Acunetix_web_application_vulnerability_report_2019.pdf) states that out of 10000 scanned web application targets, 14% were vulnerable to at least one SQL injection. This correlates to a probability distribution of `` Bernoulli(0.14) ``. 

### frequency of attack
In the ["State of the Internet" Security Web Attacks and Gaming Abuse Report 2019](https://www.akamai.com/us/en/multimedia/documents/state-of-the-internet/soti-security-web-attacks-and-gaming-abuse-report-2019.pdf) by Akamai states that 65.1% out of 3.993 billion attacks were SQL injections. This comes out to 2.599443 billion attacks in total. According to [builtwith.com](https://trends.builtwith.com/websitelist/Akamai/Historical), Akamai hosts a total of 2,421,061 live sites. This means every one of the sites using Akamai experienced on average ~1073.68 attacks over a period of time from November 1, 2017 to March 31, 2019. This is 515 days, so on average, an SQL attack was attempted 2.0848... times per day, which is an SQLi attack roughly every ~11.5 hours. 

Another source from [Imperva Web Application Attack Report, 2015](https://www.imperva.com/docs/HII_Web_Application_Attack_Report_Ed6.pdf) is a little older, but states that a median 13 SQL injections attacks occured over a period of 6 months, and a median of 72 requests occured with each attack. This comes out to 13*72=936 total over 180 days (January 1st 2015 to June 30th 2015), which means an SQL attack was attempted out 5.2 times per day, or one attack every ~4.6 hours.

If you take the average of these 2 studies, an SQL attack occurs can be expected to occur 3.6424 times per day, or one attack every 6.589 hours. 

### % of SQL injections that particularly target credentials
Not every SQL injection attack targets credentials specifically. Here I try to find how many SQL attacks are after credentials specifically.
I found a source that [classifies SQL injection attacks](https://www.cc.gatech.edu/fac/Alex.Orso/papers/halfond.viegas.orso.ISSSE06.pdf), where they list several attacker intentions. 
|Attack Intent|# of SQLi attacks with this intent|
|---|---|
|Identifying injectable parameters|3|
|Performing database finger-printing|1|
|Determining database schema|1||
|Extracting data|5|
|Adding or modifying data|1|
|Performing  denial  of  service|2|
|Evading detection|1|
|Bypassing authentication|2|
|Executing remote commands|2|
|Performing privilege escalation|1|
Out of these, only "Extracting data" and "Bypassing authentication" are related to Credential Access. The total # of different intents are 19, and those related to Credential access are 5+2=7, so 36.8% of attacks include Credential Access attacks. (Note that this does not actually represent how common the each type of SQLi is. It's more of an estimate used to separate credential access specific SQLi attacks from all the possible SQLi attacks.)

Combining this, SQL injection attacks used for credential access seem to have a frequency of occuring 3.6424 * 0.368 = ~1.34 per day. This gives a TTC exponential distribution of `` Exponential(0.746) ``. 

So for ```exploitationForCredentialAccess```, SQLi attacks get a distribution of `` Bernoulli(0.14)*Exponential(0.746) ``

## Forcing a Windows machine to try to authenticate to a remote server, to get and crack password hashes from email

### success rate of attack
From [This article from 2019](https://www.csoonline.com/article/3333916/i-can-get-and-crack-your-password-hashes-from-email.html), a hacker can easily retrieve password hashes from users. This vulnerability was patched for operating systems windows 10 and windows server 2016, so I assume that every older version of the windows OS is vulnerable to this attack. According to [Netmarketshare.com](https://netmarketshare.com/operating-system-market-share.aspx?options=%7B%22filter%22%3A%7B%22%24and%22%3A%5B%7B%22deviceType%22%3A%7B%22%24in%22%3A%5B%22Desktop%2Flaptop%22%5D%7D%7D%2C%7B%22platform%22%3A%7B%22%24in%22%3A%5B%22Windows%22%5D%7D%7D%5D%7D%2C%22dateLabel%22%3A%22Trend%22%2C%22attributes%22%3A%22share%22%2C%22group%22%3A%22platformVersion%22%2C%22sort%22%3A%7B%22share%22%3A-1%7D%2C%22id%22%3A%22platformsDesktopVersions%22%2C%22dateInterval%22%3A%22Monthly%22%2C%22dateStart%22%3A%222019-06%22%2C%22dateEnd%22%3A%222020-05%22%2C%22pageLength%22%3A100%2C%22segments%22%3A%22-1000%22%7D), windows 10 was used by 61.09% of users, so at least 38.91% of users are vulnerable to this exploit. Note that this source seemingly does not track Windows server versions, so that is not included. The way to otherwise protect against this attack is to use a strong password so the hash can't be cracked easily. 

Of these 38.91% of users, how long does it take to compromise them?
### frequency of attack
How long does it take to crack the average hashed password? According to [infosecinstitue in 2014](https://resources.infosecinstitute.com/beyond-password-length-complexity/), the average length of a password was 9.6 characters, consisted of 1.1 upper-case characters, 6.1 lower-case characters, 2.2 numbers and 0.2 special characters. In a study by [spycloud on how long it would take to crack a password](https://spycloud.com/how-long-would-it-take-to-crack-your-password/), this seems to roughly fit into the category of passwords labeled "medium" strength. It mentions differences of "time to crack" depending on which encryption technique is used. According to the same study, the following encryptions are deemed "generally stronger": bcrypt, Drupal 7, Django, SHA512 (UNIX), and DCC2/MS Cache 2. These are weaker: MYSQL323, MD4, NTLM, SipHAsh, MD5. Another study, also by [spycloud](https://spycloud.com/2020-annual-credential-exposure-report/) gives statistics of the password hashing techniques used. The stronger types, Bcrypt, django, and snefru256. These make up at least 40% of encryption algorithms used. The rest are weaker. According again to [spycloud on how long it would take to crack a password](https://spycloud.com/how-long-would-it-take-to-crack-your-password/), they conclude that a password of "medium" strength would with a weak hash take between ~12-17 minutes, but with a stronger hash take ~22 years. This means that the TTC of this attack, is a 60% chance to use weak hashes and occur within minutes. The normal distribution of the values for TTC: 742, 1074, 1049 seconds. Normal(955, 184.886...). In the MAL representation I will use TruncatedNormal instead, and with days instead of seconds. If it does not use a weak encryption method, which has a 40% chance, then it uses a stronger one, which has a TTC of 22 years. It might be possible to completely discard this as an option as it would result in a TTC of ```Exponential(0.000124450421)```. 

So to summarize the findings regarding this attack-step, for the weakness to exist in the first place, it has a pdf of ```Bernoulli(0.3891)```. Then, the chance of the encryption being weak has a chance of 60%. I'm not sure if this is how it is done when combining two binary probabilities, but it gives the total chance of the attack to succeed on a windows machine 0.3891 * 0.6 = 0.23346, so ```Bernoulli(0.23346)```. And the TTC is normally distributed with ```TruncatedNormal(0,011,0,00214)```.

### means of defense
* use strong password encryption techniques, suggested is bcrypt. 
* update windows systems to the latest version of Windows 10.

## MS14-068 [Unfinished]
Exploitation for Credential Access also includes vulnerabilities that allow an attacker to bypass the need for user credentials entirely. 

There is a lot of information on this exploit in particular but I have struggled to find data on how common it is. The TTF is also unclear. That said, given you have found a system vulnerable to the exploit, by following the steps outlined [here](https://www.trustedsec.com/blog/ms14-068-full-compromise-step-step/) the exploit can be completed in a few minutes for an experienced hacker. 

## Discussion
SQL injections appear to be the most common way of attacking for credential access, but it's unclear how many of the attacks are specifically after credentials. I use an estimate looking at the total number of objectives regarding SQL injections (attacker intent) to try to get an idea of how many of the attacks are after credentials as opposed to the other intentions. This is of course not ideal since it doesn't concern how many attacks were actually carried out with credential access in mind.

Also regarding SQLinjections, the data comes from different sources and slightly different time windows (amount of attacks over time from 2017-2019, amount of websites affected from 2020). The same concerns are valid for password strength, perhaps users have started using stronger passwords since 2014, which is when the study regarding average password strength was carried out. 

Lastly for SQL injections, the studies sourced here are regarding web applications specifically. It's not clear if this is also representative of how many locally stored applications are also vulnerable to this kind of exploit.

[^1]: text from https://attack.mitre.org/techniques/T1212/

### List of sources

Acunetix 2019 vulnerability report: https://cdn2.hubspot.net/hubfs/4595665/Acunetix_web_application_vulnerability_report_2019.pdf

"State of the Internet" Security Web Attacks and Gaming Abuse Report 2019 by Akamai https://www.akamai.com/us/en/multimedia/documents/state-of-the-internet/soti-security-web-attacks-and-gaming-abuse-report-2019.pdf

Live sites hoseted with Akamai, builtwith.com https://trends.builtwith.com/websitelist/Akamai/Historical

Imperva Web Application Attack Report, 2015 https://www.imperva.com/docs/HII_Web_Application_Attack_Report_Ed6.pdf

Classification of SQL injection attacks https://www.cc.gatech.edu/fac/Alex.Orso/papers/halfond.viegas.orso.ISSSE06.pdf

Article on how to force a Windows machine to try to authenticate to a remote server, to get and crack password hashes from email https://www.csoonline.com/article/3333916/i-can-get-and-crack-your-password-hashes-from-email.html

Windows OS version statistics https://netmarketshare.com/operating-system-market-share.aspx?

Password complexity, Infosecinstitute, 2014 https://resources.infosecinstitute.com/beyond-password-length-complexity/

Spycloud on how long it would take to crack passwords https://spycloud.com/how-long-would-it-take-to-crack-your-password/

Spycloud, statistics on hashing/encryption algorithms used https://spycloud.com/2020-annual-credential-exposure-report/

How to perform MS14-068 https://www.trustedsec.com/blog/ms14-068-full-compromise-step-step/

### Unused sources:
More on password strength: https://www.tandfonline.com/doi/abs/10.7305/automatika.2015.04.587?needAccess=true#aHR0cHM6Ly93d3cudGFuZGZvbmxpbmUuY29tL2RvaS9wZGYvMTAuNzMwNS9hdXRvbWF0aWthLjIwMTUuMDQuNTg3P25lZWRBY2Nlc3M9dHJ1ZUBAQDA=